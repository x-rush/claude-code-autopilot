# /autopilot-context-refresh
智能上下文刷新 - 帮助Claude Code在长时间执行中管理对话上下文，避免窗口限制。

## 🎯 功能说明

### 上下文管理挑战
在24小时连续执行过程中，Claude Code可能面临：
- **上下文窗口限制**：长时间对话超出上下文窗口
- **关键信息丢失**：早期的重要决策和状态信息被遗忘
- **执行连续性中断**：新对话无法获取完整的执行历史
- **状态不一致**：上下文丢失导致执行偏差

### 智能刷新机制
此命令提供智能的上下文刷新功能：
- **关键信息提取**：从历史对话中提取关键决策和状态
- **执行状态总结**：生成当前执行位置的精确总结
- **需求对齐重申**：重申原始需求和核心目标
- **执行计划同步**：同步当前执行计划和下一步行动

## 🔄 上下文刷新流程

### 第一阶段：状态信息收集
自动读取和收集以下状态文件：

1. **REQUIREMENT_ALIGNMENT.json** - 原始需求对齐结果
2. **EXECUTION_PLAN.json** - 详细执行计划
3. **TODO_TRACKER.json** - 当前执行进度
4. **DECISION_LOG.json** - 重要决策记录
5. **QUALITY_METRICS.json** - 质量指标
6. **EXECUTION_STATE.json** - 详细执行状态

### 第二阶段：智能信息提取
从状态文件中提取关键信息：

1. **核心需求摘要**
   - 用户的主要目标和期望
   - 关键交付物和质量标准
   - 重要的约束条件和特殊要求

2. **当前执行状态**
   - 已完成的任务和成果
   - 当前正在执行的任务
   - 下一步计划和时间预估

3. **重要决策记录**
   - 已做出的重要技术决策
   - 决策的依据和考虑因素
   - 决策与原始需求的一致性

4. **质量状况报告**
   - 当前的质量评分和指标
   - 已发现的问题和解决方案
   - 需求对齐验证结果

### 第三阶段：上下文重构
生成精简但完整的上下文信息：

1. **执行历史总结**
   - 按时间顺序总结重要事件
   - 突出关键里程碑和成果
   - 标注重要的决策点和解决方案

2. **当前状态快照**
   - 精确的当前执行位置
   - 已完成工作的价值总结
   - 当前任务的具体要求和进度

3. **下一步行动指南**
   - 明确的下一步执行任务
   - 执行注意事项和质量要求
   - 预期完成时间和验收标准

## 📋 生成内容模板

### 上下文刷新报告
```
## 上下文刷新报告
生成时间：[当前时间戳]
会话ID：[原始会话ID]
执行阶段：[当前执行阶段]

### 原始需求摘要
**核心目标**：[用户的主要目标]
**关键交付物**：[重要交付物列表]
**质量标准**：[质量要求摘要]
**特殊约束**：[重要约束条件]

### 当前执行状态
**总体进度**：[完成百分比] ([已完成数]/[总数])
**当前任务**：[当前正在执行的任务]
**任务状态**：[正常/延迟/异常]
**下一任务**：[即将执行的任务]

### 重要决策回顾
**技术决策**：[重要技术选择和理由]
**执行决策**：[重要执行策略选择]
**质量决策**：[质量相关的决策]

### 执行成果总结
**已完成成果**：[重要成果列表]
**质量状况**：[当前质量评分]
**需求对齐**：[与原始需求的对齐状况]

### 下一步执行指南
**立即行动**：[下一步具体行动]
**质量要求**：[质量注意事项]
**预期结果**：[预期完成标准]
**时间预估**：[预估完成时间]

### 重要提醒
- [基于当前状态的重要提醒1]
- [基于当前状态的重要提醒2]
- [需要特别注意的事项]

基于以上信息，请继续执行当前任务，保持与原始需求的完全对齐。
```

## 🔧 自动刷新策略

### 刷新触发条件
上下文刷新在以下情况下自动触发：

1. **对话长度监控**：
   - 检测到对话接近上下文窗口限制
   - 预估剩余可用上下文空间
   - 在合适的时机主动触发刷新

2. **时间间隔触发**：
   - 每执行2小时自动刷新一次
   - 确保关键信息不会丢失
   - 保持执行状态的准确性

3. **重要节点触发**：
   - 完成重要里程碑后
   - 遇到复杂决策后
   - 发现执行偏差后

### 刷新效果验证
刷新后进行效果验证：

1. **信息完整性检查**：验证关键信息是否完整
2. **执行连续性检查**：确认执行是否能正常继续
3. **需求一致性检查**：验证与原始需求的一致性
4. **质量状态检查**：确认质量指标是否正常

## 🎯 使用场景

### 适用情况
此命令适用于以下场景：

1. **长时间执行**：执行时间超过2小时的复杂项目
2. **复杂决策**：包含大量技术决策的复杂任务
3. **质量要求高**：对质量一致性要求很高的项目
4. **需求复杂**：需求复杂且需要持续对齐的项目

### 配合使用
与以下命令配合使用效果更佳：

- `/autopilot-status` - 查看详细执行状态
- `/autopilot-continuous-start` - 启动连续执行
- 智能助手监控脚本 - 自动触发上下文刷新

---

## 技术实现

### 自动化集成
此命令可以集成到智能助手中，实现：
- 自动检测上下文窗口使用情况
- 智能判断刷新时机
- 自动生成和发送刷新信息
- 验证刷新效果并调整策略

### 状态文件管理
确保状态文件的：
- 实时更新和同步
- 数据一致性和完整性
- 异常情况的恢复机制
- 版本控制和历史追踪

## 🤖 自动化上下文刷新组件

### 集成的智能刷新系统
此命令现在集成了完整的自动化上下文管理：

1. **自动状态读取**
   ```bash
   ./scripts/state-manager.sh status
   ```

2. **智能信息提取**
   - 从所有状态文件中提取关键信息
   - 生成精简的执行摘要
   - 保持需求对齐信息

3. **自动刷新触发**
   ```bash
   ./scripts/execution-monitor.sh refresh
   ```

4. **上下文健康度评估**
   - 监控上下文窗口使用率
   - 评估信息完整性
   - 调整刷新策略

### 自动化刷新特性
- **智能时机判断**: 自动检测最佳刷新时机
- **信息压缩算法**: 保留关键信息，压缩冗余内容
- **连续性保证**: 确保执行不会因上下文丢失而中断
- **质量维持**: 刷新后保持与原始需求的一致性

### 集成监控机制
- **实时监控**: 持续监控上下文使用情况
- **预测刷新**: 基于使用趋势预测刷新时机
- **自动执行**: 无需手动干预的自动刷新
- **效果验证**: 刷新后自动验证执行连续性

---

## 🚀 使用方法

### 自动刷新（推荐）
```bash
/autopilot-context-refresh
```

### 手动触发刷新
如需手动控制刷新时机：

1. **仅刷新上下文**
   ```bash
   ./scripts/execution-monitor.sh refresh
   ```

2. **生成刷新报告**
   ```bash
   ./scripts/state-manager.sh status > context-refresh-report.md
   ```

3. **验证刷新效果**
   ```bash
   /autopilot-status  # 检查刷新后状态
   ```

### 自动刷新配置
系统默认配置：
- **刷新间隔**: 每2小时自动刷新
- **触发阈值**: 上下文使用率达到80%时刷新
- **检查点刷新**: 每完成5个任务后刷新
- **异常刷新**: 检测到异常时立即刷新

---

## ⚡ 自动化优势

**这是一个完全自动化的智能上下文管理系统**，集成在监控守护进程中，能够：

1. **自动检测**: 实时监控上下文窗口使用情况
2. **智能判断**: 基于多种因素判断最佳刷新时机
3. **自动执行**: 无需人工干预的自动刷新流程
4. **连续保证**: 确保24小时连续执行不受上下文限制影响
5. **质量维持**: 刷新过程中保持执行质量和需求对齐

**真正解决了长时间自主执行中的上下文窗口限制问题**，是24小时连续执行的关键技术保障。