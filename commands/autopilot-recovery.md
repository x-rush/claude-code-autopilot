# /autopilot-recovery
智能恢复机制 - 在Claude Code异常中断后自动恢复执行状态和继续工作。

## 🎯 恢复场景

### 常见中断情况
Claude Code在24小时执行过程中可能遇到：

1. **系统级中断**
   - 系统重启或关机
   - 网络连接中断
   - 电源故障
   - 系统资源耗尽

2. **应用级中断**
   - Claude Code进程崩溃
   - 内存溢出
   - 对话超时
   - 权限问题

3. **环境级中断**
   - 磁盘空间不足
   - 依赖工具缺失
   - 配置文件损坏
   - 外部服务不可用

### 恢复目标
- **状态完整性**：完整恢复中断前的执行状态
- **执行连续性**：从中断点无缝继续执行
- **数据一致性**：确保所有状态文件的一致性
- **质量保证**：恢复后继续满足质量要求

## 🔄 恢复流程

### 第一阶段：状态检测和诊断
自动检测当前状态：

1. **进程状态检查**
   ```bash
   # 检查Claude Code进程
   pgrep -f "claude.*autopilot" || echo "Claude进程未运行"

   # 检查相关进程
   ps aux | grep -E "(claude|autopilot)"
   ```

2. **文件完整性检查**
   - 检查所有状态文件是否存在
   - 验证文件格式和内容完整性
   - 检查文件权限和可访问性

3. **数据一致性检查**
   - 验证各状态文件的时间戳一致性
   - 检查进度数据的逻辑一致性
   - 识别可能的损坏或不一致

### 第二阶段：状态恢复
根据检测结果执行恢复：

1. **状态文件恢复**
   ```json
   // 检查并修复状态文件
   {
     "recovery_actions": [
       "修复损坏的JSON文件",
       "同步文件时间戳",
       "重建缺失的状态文件",
       "验证数据完整性"
     ]
   }
   ```

2. **执行状态重建**
   - 基于可用信息重建执行状态
   - 确定中断的具体位置
   - 识别已完成和未完成的任务
   - 建立恢复后的执行计划

3. **上下文信息恢复**
   - 提取关键的历史决策信息
   - 重建当前任务的执行上下文
   - 恢复与原始需求的对齐信息

### 第三阶段：执行恢复
恢复执行并继续工作：

1. **环境准备**
   - 确保执行环境满足要求
   - 检查必要工具和依赖
   - 验证安全边界设置

2. **Claude Code重启**
   ```bash
   # 使用相同参数重启Claude
   claude --dangerously-skip-permissions
   ```

3. **状态同步**
   - 向Claude发送恢复信息
   - 同步当前执行状态
   - 确认恢复后的执行计划

## 📊 恢复状态报告

### 恢复前后对比
```
## 恢复状态报告

### 中断信息
**中断时间**：[检测到的中断时间]
**中断原因**：[分析的中断原因]
**中断位置**：[中断时正在执行的任务]

### 恢复信息
**恢复时间**：[开始恢复的时间]
**恢复耗时**：[恢复过程花费的时间]
**恢复方式**：[使用的恢复策略]

### 状态对比
**中断前进度**：[中断前的完成进度]
**恢复后进度**：[恢复后的完成进度]
**数据完整性**：[数据恢复的完整性状态]

### 继续执行计划
**当前任务**：[需要继续执行的任务]
**恢复策略**：[具体的恢复执行策略]
**预期影响**：[恢复对执行的影响评估]
```

### 恢复质量评估
```
## 恢复质量评估

### 完整性评分
- **状态文件完整性**：[评分]/10
- **数据一致性**：[评分]/10
- **上下文连续性**：[评分]/10
- **总体恢复质量**：[评分]/10

### 风险评估
- **数据丢失风险**：[低/中/高]
- **执行偏差风险**：[低/中/高]
- **质量影响风险**：[低/中/高]
- **总体风险等级**：[低/中/高]

### 后续监控建议
- **监控频率**：[建议的监控频率]
- **关键检查点**：[需要重点检查的项目]
- **应急预案**：[异常情况的应急处理]
```

## 🔧 自动恢复机制

### 智能检测
自动检测中断情况：

1. **心跳监控**
   ```javascript
   // 检测Claude进程的心跳
   setInterval(() => {
     if (!isClaudeRunning()) {
       triggerRecoveryProcess();
     }
   }, 30000); // 每30秒检查一次
   ```

2. **状态文件监控**
   - 监控状态文件的更新时间
   - 检测文件大小和内容变化
   - 识别异常的文件状态

3. **执行进度监控**
   - 监控TODO进度的更新频率
   - 检测长时间无进度更新的情况
   - 识别可能的执行停滞

### 自动恢复策略
根据不同情况采用不同的恢复策略：

1. **轻微中断恢复**
   - 重启Claude Code进程
   - 重新加载状态文件
   - 继续执行当前任务

2. **中度中断恢复**
   - 重建部分状态信息
   - 重新验证执行环境
   - 从检查点恢复执行

3. **严重中断恢复**
   - 完整重建执行状态
   - 重新开始执行计划
   - 人工确认后继续

## 🛡️ 安全保障

### 数据保护
- **备份机制**：重要状态文件的多重备份
- **版本控制**：状态文件的历史版本管理
- **校验机制**：数据完整性和一致性校验

### 安全检查
- **环境验证**：恢复前验证执行环境的安全性
- **权限检查**：确保恢复操作在安全权限范围内
- **操作审计**：记录所有恢复操作供审计

## 🎯 使用指南

### 手动恢复
如果自动恢复失败，可以手动执行：

1. **运行恢复命令**
   ```
   /autopilot-recovery
   ```

2. **根据恢复报告操作**
   - 查看恢复状态报告
   - 确认恢复结果
   - 继续执行或进一步修复

3. **验证恢复效果**
   ```
   /autopilot-status
   ```

### 恢复后建议
恢复完成后建议：

1. **增加监控频率**：提高对执行状态的监控频率
2. **设置检查点**：在关键位置设置额外的检查点
3. **备份重要数据**：及时备份重要的执行结果
4. **优化执行环境**：改善执行环境以提高稳定性

## 🔧 自动化恢复组件

### 集成的恢复工具集
此命令现在集成了完整的自动化恢复工具：

1. **智能状态检测**
   ```bash
   ./scripts/state-manager.sh check
   ./scripts/execution-monitor.sh check
   ```

2. **自动状态备份**
   ```bash
   ./scripts/state-manager.sh backup
   ```

3. **检查点恢复**
   ```bash
   # 从最新检查点恢复
   latest_checkpoint=$(ls -t autopilot-recovery-points/*/checkpoint-meta.json | head -1)
   ```

4. **进程状态恢复**
   ```bash
   ./scripts/execution-monitor.sh restart
   ./scripts/autopilot-engine.sh start
   ```

### 自动化恢复流程
1. **问题检测**: 自动识别中断类型和严重程度
2. **状态评估**: 分析现有状态文件的完整性
3. **恢复策略选择**: 根据情况选择最佳恢复方案
4. **自动执行恢复**: 无需人工干预的恢复过程
5. **验证恢复结果**: 确保恢复成功并继续执行

### 智能恢复决策树
- **轻微问题**: 自动重启相关进程
- **中度问题**: 从检查点恢复状态
- **严重问题**: 重新初始化并重建状态
- **灾难性问题**: 人工介入建议

---

## 🚀 使用方法

### 自动恢复（推荐）
```bash
/autopilot-recovery
```

此命令将自动执行：
1. **系统诊断**: 检测所有组件状态
2. **问题分析**: 识别中断原因和影响范围
3. **恢复执行**: 选择并执行最佳恢复策略
4. **结果验证**: 确保恢复成功
5. **继续执行**: 自动继续未完成的任务

### 手动恢复选项
如需手动控制恢复过程：

1. **仅检查状态**
   ```bash
   ./scripts/state-manager.sh status
   ```

2. **强制重启系统**
   ```bash
   ./scripts/execution-monitor.sh restart
   ```

3. **从备份恢复**
   ```bash
   ./scripts/state-manager.sh backup  # 先备份当前状态
   # 然后选择恢复策略
   ```

### 恢复后验证
恢复完成后，运行以下命令验证：
```bash
/autopilot-status    # 检查执行状态
```

---

**这是一个完全自动化的智能恢复系统**，集成了状态管理、监控守护和执行引擎，确保在任何异常情况下都能快速恢复并继续执行，真正实现24小时无人值守的连续自主执行。