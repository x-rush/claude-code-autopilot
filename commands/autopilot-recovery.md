---
description: 智能恢复机制 - 基于结构定义的纯插件实现
---

# /autopilot-recovery
智能恢复机制 - 基于结构定义文件和运行时状态，在Claude Code异常中断后自动恢复执行状态和继续工作，确保24小时无人值守执行的连续性。

## 🎯 恢复约束

**严格遵循结构定义驱动**：
- **基于结构定义验证**：使用 [`templates/`](templates/) 中的结构定义文件验证和恢复状态
- **纯插件检测**：Claude Code直接检测和分析运行时状态文件
- **智能状态重建**：基于可用数据智能重建缺失或损坏的状态信息
- **执行连续性保证**：确保恢复后能够无缝继续执行
- **需求对齐维持**：恢复过程保持与原始需求的完全对齐

## 📋 中断场景分析

### 1. 系统级中断
在24小时连续执行过程中可能遇到：

#### 系统环境问题
- **系统重启或关机**：操作系统重启导致的执行中断
- **网络连接中断**：网络故障影响外部依赖访问
- **电源故障**：断电或电源不稳定导致系统中断
- **系统资源耗尽**：内存、磁盘等资源不足导致执行中断

#### 进程级问题
- **Claude Code进程崩溃**：应用程序异常退出
- **内存溢出**：内存使用超过限制导致进程终止
- **对话超时**：长时间无交互导致会话超时
- **权限问题**：权限变更导致文件访问受限

### 2. 环境级中断
执行环境变化导致的问题：

#### 存储和文件系统
- **磁盘空间不足**：存储空间耗尽影响文件操作
- **文件系统损坏**：文件系统错误影响文件读写
- **文件权限变更**：权限设置变化影响文件访问
- **配置文件损坏**：系统配置文件损坏影响执行

#### 依赖和服务
- **依赖工具缺失**：必要的系统工具被删除或损坏
- **外部服务不可用**：依赖的外部服务中断
- **环境变量丢失**：系统环境变量被重置
- **系统库更新**：系统库更新导致兼容性问题

## 🔄 智能恢复流程

### 1. 结构定义验证
```javascript
// Claude Code内部处理流程
首先验证templates/目录中的结构定义文件：
1. 读取 templates/EXECUTION_STATE.json 验证执行状态结构
2. 读取 templates/TODO_TRACKER.json 验证任务跟踪结构
3. 读取 templates/DECISION_LOG.json 验证决策记录结构
4. 读取 templates/REQUIREMENT_ALIGNMENT.json 验证需求对齐结构
5. 读取 templates/EXECUTION_PLAN.json 验证执行计划结构
```

### 2. 运行时状态检测
```javascript
// 检测运行时状态文件的健康状况
检测以下运行时生成的JSON状态文件：
- REQUIREMENT_ALIGNMENT.json（需求对齐状态）
- EXECUTION_PLAN.json（执行计划状态）
- TODO_TRACKER.json（任务进度状态）
- DECISION_LOG.json（决策记录状态）
- EXECUTION_STATE.json（执行状态管理）
```

### 3. 中断情况分析
```javascript
// 分析中断的原因和影响范围
1. 文件存在性检查：确定哪些状态文件丢失或损坏
2. 数据完整性验证：检查现有数据的完整性和一致性
3. 时间戳分析：分析文件更新时间确定中断时刻
4. 依赖关系检查：验证状态文件间的数据关联性
```

## 🧠 智能状态恢复

### 1. 轻微问题自动修复
```javascript
// 处理轻微的文件损坏或格式问题
if (JSON格式错误 || 字段缺失) {
  1. 基于结构定义修复JSON格式错误
  2. 补充缺失的必需字段（使用默认值或推断值）
  3. 修正数据类型错误
  4. 验证修复后的数据完整性
}
```

### 2. 中度问题重建恢复
```javascript
// 处理部分文件丢失或严重损坏
if (文件部分损坏 || 部分文件丢失) {
  1. 从其他状态文件推断丢失的数据
  2. 基于时间戳重建损坏的数据片段
  3. 使用逻辑关系补全不完整的信息
  4. 创建数据备份并验证重建结果
}
```

### 3. 严重问题重新初始化
```javascript
// 处理严重的数据丢失或无法修复的损坏
if (文件完全丢失 || 无法修复的损坏) {
  1. 基于结构定义重新生成状态文件框架
  2. 从可用的任何信息中恢复关键数据
  3. 设置重新初始化标记和人工确认流程
  4. 提供详细的恢复报告和风险评估
}
```

## 📊 恢复状态分析

### 1. 中断点识别
```javascript
// 确定执行中断的具体位置
1. 从EXECUTION_STATE.json分析最后执行位置
2. 从TODO_TRACKER.json确定未完成的任务
3. 从DECISION_LOG.json分析中断前的决策
4. 识别中断时正在执行的具体操作
```

### 2. 数据完整性评估
```javascript
// 评估恢复后的数据完整性
1. 验证所有状态文件符合结构定义
2. 检查文件间数据的一致性和关联性
3. 确认时间戳和ID的逻辑正确性
4. 评估数据丢失对执行连续性的影响
```

### 3. 执行连续性分析
```javascript
// 分析恢复后的执行连续性
1. 确定可以安全继续执行的起点
2. 识别需要重新执行的任务或步骤
3. 评估中断对整体进度的潜在影响
4. 制定恢复后的执行策略和注意事项
```

## 🔗 恢复报告生成

### 标准恢复报告格式
```markdown
## 智能恢复报告
**恢复时间**: [ISO_TIMESTAMP]
**中断检测时间**: [中断检测时间]
**恢复耗时**: [恢复过程耗时]
**恢复策略**: [使用的恢复策略]

### 中断情况分析
**中断类型**: [系统级/应用级/环境级]
**中断原因**: [分析的具体中断原因]
**中断位置**: [中断时的执行位置]
**影响范围**: [中断对执行的影响评估]

### 状态文件恢复情况
**REQUIREMENT_ALIGNMENT.json**: [恢复状态]
**EXECUTION_PLAN.json**: [恢复状态]
**TODO_TRACKER.json**: [恢复状态]
**DECISION_LOG.json**: [恢复状态]
**EXECUTION_STATE.json**: [恢复状态]

### 数据完整性评估
**文件完整性**: [评分]/10
**数据一致性**: [评分]/10
**时间戳逻辑**: [评分]/10
**关联性验证**: [评分]/10
**总体完整性**: [评分]/10

### 执行连续性评估
**可继续执行**: [是/否]
**需要重新执行**: [需要重新执行的任务列表]
**进度影响**: [对整体进度的影响]
**质量影响**: [对执行质量的影响]

### 恢复后执行计划
**建议起点**: [建议的执行起点]
**注意事项**: [恢复后的注意事项]
**监控建议**: [建议的监控措施]
**应急预案**: [异常情况的应急预案]

**恢复约束**: 严格按照恢复后的状态继续执行，确保与原始需求的完全对齐。
```

## ⚙️ 使用方法

### 自动智能恢复
```bash
/autopilot-recovery
```
执行完整的智能恢复：
1. 检测所有状态文件的完整性和一致性
2. 分析中断原因和影响范围
3. 基于结构定义文件执行智能恢复
4. 生成详细的恢复报告和执行计划
5. 提供恢复后的执行指导

### 状态检查和诊断
```bash
/autopilot-recovery --check
```
执行状态检查和诊断：
1. 验证所有状态文件的存在和格式
2. 检查数据完整性和一致性
3. 分析潜在的恢复需求
4. 提供诊断报告和建议

### 自动修复状态
```bash
/autopilot-recovery --auto-fix
```
执行自动状态修复：
1. 自动修复轻微的格式和字段错误
2. 重建部分损坏的数据
3. 同步文件间的数据一致性
4. 验证修复后的状态完整性

### 强制重新初始化
```bash
/autopilot-recovery --reinit
```
执行强制重新初始化：
1. 基于结构定义重新生成所有状态文件
2. 从可用信息中恢复关键数据
3. 标记重新初始化状态
4. 请求用户确认后继续执行

## 📝 注意事项

### 结构定义驱动恢复
- 所有恢复操作都基于templates/中的结构定义
- 确保恢复后的数据符合预期的数据结构
- 恢复过程保持数据结构的一致性

### 纯插件实现
- 完全由Claude Code自主执行恢复过程
- 不依赖任何外部脚本或恢复工具
- 直接读取、解析和修复JSON状态文件

### 智能恢复决策
- 基于状态文件分析智能选择恢复策略
- 根据数据完整性评估恢复的可行性
- 确保恢复过程的可靠性和安全性

### 执行连续性保证
- 恢复后确保能够无缝继续执行
- 最小化中断对整体执行进度的影响
- 保持与原始需求的对齐和质量标准

### 安全性和可靠性
- 恢复过程中创建数据备份
- 验证恢复结果的正确性和完整性
- 提供详细的恢复报告和风险评估

---

现在开始执行智能恢复。我将基于结构定义文件检测运行时状态，分析中断情况，执行智能恢复操作，确保24小时连续执行的连续性。

## 📊 恢复状态报告

### 恢复前后对比
```
## 恢复状态报告

### 中断信息
**中断时间**：[检测到的中断时间]
**中断原因**：[分析的中断原因]
**中断位置**：[中断时正在执行的任务]

### 恢复信息
**恢复时间**：[开始恢复的时间]
**恢复耗时**：[恢复过程花费的时间]
**恢复方式**：[使用的恢复策略]

### 状态对比
**中断前进度**：[中断前的完成进度]
**恢复后进度**：[恢复后的完成进度]
**数据完整性**：[数据恢复的完整性状态]

### 继续执行计划
**当前任务**：[需要继续执行的任务]
**恢复策略**：[具体的恢复执行策略]
**预期影响**：[恢复对执行的影响评估]
```

### 恢复质量评估
```
## 恢复质量评估

### 完整性评分
- **状态文件完整性**：[评分]/10
- **数据一致性**：[评分]/10
- **上下文连续性**：[评分]/10
- **总体恢复质量**：[评分]/10

### 风险评估
- **数据丢失风险**：[低/中/高]
- **执行偏差风险**：[低/中/高]
- **质量影响风险**：[低/中/高]
- **总体风险等级**：[低/中/高]

### 后续监控建议
- **监控频率**：[建议的监控频率]
- **关键检查点**：[需要重点检查的项目]
- **应急预案**：[异常情况的应急处理]
```

## 🔧 自动恢复机制

### 智能检测
自动检测中断情况：

1. **心跳监控**
   ```javascript
   // 检测Claude进程的心跳
   setInterval(() => {
     if (!isClaudeRunning()) {
       triggerRecoveryProcess();
     }
   }, 30000); // 每30秒检查一次
   ```

2. **状态文件监控**
   - 监控状态文件的更新时间
   - 检测文件大小和内容变化
   - 识别异常的文件状态

3. **执行进度监控**
   - 监控TODO进度的更新频率
   - 检测长时间无进度更新的情况
   - 识别可能的执行停滞

### 自动恢复策略
根据不同情况采用不同的恢复策略：

1. **轻微中断恢复**
   - 重启Claude Code进程
   - 重新加载状态文件
   - 继续执行当前任务

2. **中度中断恢复**
   - 重建部分状态信息
   - 重新验证执行环境
   - 从检查点恢复执行

3. **严重中断恢复**
   - 完整重建执行状态
   - 重新开始执行计划
   - 人工确认后继续

## 🛡️ 安全保障

### 数据保护
- **备份机制**：重要状态文件的多重备份
- **版本控制**：状态文件的历史版本管理
- **校验机制**：数据完整性和一致性校验

### 安全检查
- **环境验证**：恢复前验证执行环境的安全性
- **权限检查**：确保恢复操作在安全权限范围内
- **操作审计**：记录所有恢复操作供审计

## 🎯 使用指南

### 手动恢复
如果自动恢复失败，可以手动执行：

1. **运行恢复命令**
   ```
   /autopilot-recovery
   ```

2. **根据恢复报告操作**
   - 查看恢复状态报告
   - 确认恢复结果
   - 继续执行或进一步修复

3. **验证恢复效果**
   ```
   /autopilot-status
   ```

### 恢复后建议
恢复完成后建议：

1. **增加监控频率**：提高对执行状态的监控频率
2. **设置检查点**：在关键位置设置额外的检查点
3. **备份重要数据**：及时备份重要的执行结果
4. **优化执行环境**：改善执行环境以提高稳定性

## 🔧 纯插件恢复机制

### 智能恢复系统
此命令采用纯插件实现，提供完整的恢复功能：

1. **直接状态检测**
   - Claude Code直接读取JSON状态文件
   - 验证文件完整性和数据一致性
   - 分析状态文件间的关联关系

2. **智能状态备份**
   - 自动创建状态文件备份
   - 维护多个恢复点
   - 支持增量备份策略

3. **检查点恢复**
   - 从最新有效状态恢复
   - 基于时间戳选择最佳恢复点
   - 智能重建缺失数据

4. **执行状态恢复**
   - 重建当前执行上下文
   - 确定中断位置和恢复策略
   - 继续执行未完成任务

### 纯插件恢复流程
1. **问题检测**: 自动识别状态文件异常
2. **状态评估**: 分析现有数据的完整性
3. **恢复策略选择**: 根据情况选择最佳方案
4. **智能执行恢复**: 基于AI的恢复决策
5. **验证恢复结果**: 确保恢复成功并继续执行

### 智能恢复决策树
- **轻微问题**: 自动修复JSON格式错误
- **中度问题**: 从备份恢复状态数据
- **严重问题**: 重新初始化状态文件
- **灾难性问题**: 提供人工介入指导

---

## 🚀 使用方法

### 自动恢复（推荐）
```bash
/autopilot-recovery
```

此命令将自动执行：
1. **系统诊断**: 检测所有组件状态
2. **问题分析**: 识别中断原因和影响范围
3. **恢复执行**: 选择并执行最佳恢复策略
4. **结果验证**: 确保恢复成功
5. **继续执行**: 自动继续未完成的任务

### 手动恢复选项
如需手动控制恢复过程：

1. **仅检查状态**
   ```bash
   /autopilot-recovery --check
   ```

2. **自动修复状态**
   ```bash
   /autopilot-recovery --auto-fix
   ```

3. **交互式恢复**
   ```bash
   /autopilot-recovery --interactive
   ```

### 恢复后验证
恢复完成后，运行以下命令验证：
```bash
/autopilot-status    # 检查执行状态
/autopilot-align     # 验证需求对齐
```

---

**这是一个完全基于Claude Code原生能力的智能恢复系统**，采用纯插件实现，确保在任何异常情况下都能快速恢复并继续执行，真正实现24小时无人值守的连续自主执行。